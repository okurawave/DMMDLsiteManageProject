{% extends "layout.html" %}

{% block title %}重複チェック | DMM/DLsite 購入管理{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/duplicate-check.css') }}">
{% endblock %}

{% block content %}
<h1 class="mb-4">重複チェック</h1>

<div class="card mb-4 duplicate-check-page">
    <div class="card-header">
        <h5>重複検出設定</h5>
    </div>
    <div class="card-body">
        <p>
            このページでは、DMMとDLsiteの両方で購入されている可能性のある商品を検出し、比較します。
            重複の検出は、商品のタイトル類似性とメーカー/サークル名を基に行われます。
        </p>
        
        <form id="duplicate-settings-form" method="get" action="{{ url_for('main.check_duplicates') }}" class="row g-3">
            <div class="col-md-4">
                <label for="threshold" class="form-label">類似度閾値</label>
                <div class="input-group">
                    <input type="range" class="form-range" id="threshold" name="threshold" 
                           min="0.5" max="0.95" step="0.05" value="{{ threshold|default(0.75) }}">
                    <span class="input-group-text" id="threshold-value">{{ threshold|default(0.75) }}</span>
                </div>
                <div class="form-text">値が高いほど厳密な一致が必要になります</div>
            </div>
            
            <div class="col-md-4">
                <label for="max_results" class="form-label">最大結果数</label>
                <select class="form-select" id="max_results" name="max_results">
                    <option value="20" {% if max_results == 20 %}selected{% endif %}>20件</option>
                    <option value="50" {% if max_results == 50 %}selected{% endif %}>50件</option>
                    <option value="100" {% if max_results == 100 %}selected{% endif %}>100件</option>
                    <option value="200" {% if max_results == 200 %}selected{% endif %}>200件</option>
                </select>
            </div>
            
            <div class="col-md-4">
                <label for="algo" class="form-label">アルゴリズム</label>
                <select class="form-select" id="algo" name="algo">
                    <option value="tfidf" {% if use_tfidf %}selected{% endif %}>TF-IDF + コサイン類似度</option>
                    <option value="levenshtein" {% if not use_tfidf %}selected{% endif %}>レーベンシュタイン距離</option>
                </select>
            </div>
            
            <div class="col-md-6">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="use_circle" name="use_circle" value="true" {% if use_circle %}checked{% endif %}>
                    <label class="form-check-label" for="use_circle">
                        サークル名/メーカー名の一致も考慮する
                    </label>
                </div>
            </div>
            
            <div class="col-12 text-center">
                <button id="check-duplicates-btn" type="submit" class="btn btn-warning mb-3">
                    <i class="fas fa-search"></i> 重複をチェック
                </button>
            </div>
        </form>
        
        <div id="loading-indicator" style="display: none;">
            <div class="d-flex align-items-center">
                <strong>検索中...</strong>
                <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
            </div>
        </div>
    </div>
</div>

{% if duplicates %}
    <div class="card mb-4">
        <div class="card-header">
            <h5>検出された重複候補 ({{ duplicates|length }}件)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>DMM商品</th>
                            <th>DLsite商品</th>
                            <th>類似度</th>
                            <th>価格差</th>
                            <th>アクション</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pair in duplicates %}
                            <tr>
                                <td>
                                    {% set dmm_product = pair.dmm_product %}
                                    <a href="{{ url_for('main.product_detail', id=dmm_product.id) }}">
                                        {{ dmm_product.title }}
                                    </a>
                                    <br>
                                    <small class="text-muted">{{ dmm_product.maker }}</small>
                                    <br>
                                    <span class="fw-bold">¥{{ dmm_product.price }}</span>
                                </td>
                                <td>
                                    {% set dlsite_product = pair.dlsite_product %}
                                    <a href="{{ url_for('main.product_detail', id=dlsite_product.id) }}">
                                        {{ dlsite_product.title }}
                                    </a>
                                    <br>
                                    <small class="text-muted">{{ dlsite_product.maker }}</small>
                                    <br>
                                    <span class="fw-bold">¥{{ dlsite_product.price }}</span>
                                </td>
                                <td>
                                    <div class="progress">
                                        {% set similarity_percentage = pair.similarity * 100 %}
                                        <div class="progress-bar bg-info" role="progressbar" 
                                             style="width: {{ similarity_percentage }}%;" 
                                             aria-valuenow="{{ similarity_percentage }}" 
                                             aria-valuemin="0" aria-valuemax="100">
                                            {{ similarity_percentage | round(1) }}%
                                        </div>
                                    </div>
                                    {% if pair.maker_match %}
                                        <span class="badge bg-success mt-1">サークル一致</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set price_diff = pair.price_diff %}
                                    {% if price_diff > 0 %}
                                        <span class="text-danger">DLsiteの方が {{ price_diff }}円安い</span>
                                    {% elif price_diff < 0 %}
                                        <span class="text-success">DMMの方が {{ price_diff * -1 }}円安い</span>
                                    {% else %}
                                        <span class="text-muted">同じ価格</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary compare-btn" 
                                            data-dmm-id="{{ dmm_product.id }}" 
                                            data-dlsite-id="{{ dlsite_product.id }}">
                                        <i class="fas fa-exchange-alt"></i> 詳細比較
                                    </button>
                                    {% if dmm_product.url %}
                                        <a href="{{ dmm_product.url }}" target="_blank" class="btn btn-sm btn-outline-secondary mt-1">
                                            <i class="fas fa-external-link-alt"></i> DMMで表示
                                        </a>
                                    {% endif %}
                                    {% if dlsite_product.url %}
                                        <a href="{{ dlsite_product.url }}" target="_blank" class="btn btn-sm btn-outline-secondary mt-1">
                                            <i class="fas fa-external-link-alt"></i> DLsiteで表示
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> 重複している可能性のある商品は見つかりませんでした。「重複をチェック」ボタンを押して検索を実行してください。
    </div>
{% endif %}

<!-- 詳細比較モーダル -->
<div class="modal fade" id="compareModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">商品詳細比較</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">DMM商品</h6>
                        <div id="dmm-product-details"></div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">DLsite商品</h6>
                        <div id="dlsite-product-details"></div>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-top">
                    <h6>比較結果</h6>
                    <div id="comparison-results"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/duplicate-check.js') }}"></script>
{% endblock %}