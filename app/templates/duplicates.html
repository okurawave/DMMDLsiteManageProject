{% extends "layout.html" %}

{% block title %}重複チェック | DMM/DLsite 購入管理{% endblock %}

{% block content %}
<h1 class="mb-4">重複チェック</h1>

<div class="card mb-4">
    <div class="card-header">
        <h5>重複検出設定</h5>
    </div>
    <div class="card-body">
        <p>
            このページでは、DMMとDLsiteの両方で購入されている可能性のある商品を検出し、比較します。
            重複の検出は、商品のタイトル類似性とメーカー/サークル名を基に行われます。
        </p>
        
        <form id="duplicate-settings-form" method="get" action="{{ url_for('main.check_duplicates') }}" class="row g-3">
            <div class="col-md-4">
                <label for="threshold" class="form-label">類似度閾値</label>
                <div class="input-group">
                    <input type="range" class="form-range" id="threshold" name="threshold" 
                           min="0.5" max="0.95" step="0.05" value="{{ threshold|default(0.75) }}">
                    <span class="input-group-text" id="threshold-value">{{ threshold|default(0.75) }}</span>
                </div>
                <div class="form-text">値が高いほど厳密な一致が必要になります</div>
            </div>
            
            <div class="col-md-4">
                <label for="max_results" class="form-label">最大結果数</label>
                <select class="form-select" id="max_results" name="max_results">
                    <option value="20" {% if max_results == 20 %}selected{% endif %}>20件</option>
                    <option value="50" {% if max_results == 50 %}selected{% endif %}>50件</option>
                    <option value="100" {% if max_results == 100 %}selected{% endif %}>100件</option>
                    <option value="200" {% if max_results == 200 %}selected{% endif %}>200件</option>
                </select>
            </div>
            
            <div class="col-md-4">
                <label for="algo" class="form-label">アルゴリズム</label>
                <select class="form-select" id="algo" name="algo">
                    <option value="tfidf" {% if use_tfidf %}selected{% endif %}>TF-IDF + コサイン類似度</option>
                    <option value="levenshtein" {% if not use_tfidf %}selected{% endif %}>レーベンシュタイン距離</option>
                </select>
            </div>
            
            <div class="col-md-6">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="use_circle" name="use_circle" value="true" {% if use_circle %}checked{% endif %}>
                    <label class="form-check-label" for="use_circle">
                        サークル名/メーカー名の一致も考慮する
                    </label>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="legacy" name="legacy" value="true" {% if use_legacy %}checked{% endif %}>
                    <label class="form-check-label" for="legacy">
                        旧式の重複検出アルゴリズムを使用する
                    </label>
                    <div class="form-text">問題がある場合は、こちらを選択してください</div>
                </div>
            </div>
            
            <div class="col-12 text-center">
                <button id="check-duplicates-btn" type="submit" class="btn btn-warning mb-3">
                    <i class="fas fa-search"></i> 重複をチェック
                </button>
            </div>
        </form>
        
        <div id="loading-indicator" style="display: none;">
            <div class="d-flex align-items-center">
                <strong>検索中...</strong>
                <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
            </div>
        </div>
    </div>
</div>

{% if duplicates %}
    <div class="card mb-4">
        <div class="card-header">
            <h5>検出された重複候補 ({{ duplicates|length }}件)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>DMM商品</th>
                            <th>DLsite商品</th>
                            <th>類似度</th>
                            <th>価格差</th>
                            <th>アクション</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pair in duplicates %}
                            <tr>
                                <td>
                                    {% set dmm_product = pair.dmm_product %}
                                    <a href="{{ url_for('main.product_detail', id=dmm_product.id) }}">
                                        {{ dmm_product.title }}
                                    </a>
                                    <br>
                                    <small class="text-muted">{{ dmm_product.maker }}</small>
                                    <br>
                                    <span class="fw-bold">¥{{ dmm_product.price }}</span>
                                </td>
                                <td>
                                    {% set dlsite_product = pair.dlsite_product %}
                                    <a href="{{ url_for('main.product_detail', id=dlsite_product.id) }}">
                                        {{ dlsite_product.title }}
                                    </a>
                                    <br>
                                    <small class="text-muted">{{ dlsite_product.maker }}</small>
                                    <br>
                                    <span class="fw-bold">¥{{ dlsite_product.price }}</span>
                                </td>
                                <td>
                                    <div class="progress">
                                        {% set similarity_percentage = pair.similarity * 100 %}
                                        <div class="progress-bar bg-info" role="progressbar" 
                                             style="width: {{ similarity_percentage }}%;" 
                                             aria-valuenow="{{ similarity_percentage }}" 
                                             aria-valuemin="0" aria-valuemax="100">
                                            {{ similarity_percentage | round(1) }}%
                                        </div>
                                    </div>
                                    {% if pair.maker_match %}
                                        <span class="badge bg-success mt-1">サークル一致</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set price_diff = pair.price_diff %}
                                    {% if price_diff > 0 %}
                                        <span class="text-danger">DLsiteの方が {{ price_diff }}円安い</span>
                                    {% elif price_diff < 0 %}
                                        <span class="text-success">DMMの方が {{ price_diff * -1 }}円安い</span>
                                    {% else %}
                                        <span class="text-muted">同じ価格</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary compare-btn" 
                                            data-dmm-id="{{ dmm_product.id }}" 
                                            data-dlsite-id="{{ dlsite_product.id }}">
                                        <i class="fas fa-exchange-alt"></i> 詳細比較
                                    </button>
                                    {% if dmm_product.url %}
                                        <a href="{{ dmm_product.url }}" target="_blank" class="btn btn-sm btn-outline-secondary mt-1">
                                            <i class="fas fa-external-link-alt"></i> DMMで表示
                                        </a>
                                    {% endif %}
                                    {% if dlsite_product.url %}
                                        <a href="{{ dlsite_product.url }}" target="_blank" class="btn btn-sm btn-outline-secondary mt-1">
                                            <i class="fas fa-external-link-alt"></i> DLsiteで表示
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> 重複している可能性のある商品は見つかりませんでした。「重複をチェック」ボタンを押して検索を実行してください。
    </div>
{% endif %}

<!-- 詳細比較モーダル -->
<div class="modal fade" id="compareModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">商品詳細比較</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">DMM商品</h6>
                        <div id="dmm-product-details"></div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">DLsite商品</h6>
                        <div id="dlsite-product-details"></div>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-top">
                    <h6>比較結果</h6>
                    <div id="comparison-results"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 類似度閾値スライダーの値表示
        const thresholdSlider = document.getElementById('threshold');
        const thresholdValue = document.getElementById('threshold-value');
        if (thresholdSlider && thresholdValue) {
            thresholdSlider.addEventListener('input', function() {
                thresholdValue.textContent = this.value;
            });
        }
        
        // 重複チェックボタンの処理
        document.getElementById('duplicate-settings-form').addEventListener('submit', function() {
            document.getElementById('loading-indicator').style.display = 'block';
        });
        
        // 詳細比較ボタンの処理
        document.querySelectorAll('.compare-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var dmmId = this.getAttribute('data-dmm-id');
                var dlsiteId = this.getAttribute('data-dlsite-id');
                
                // モーダル内の情報をクリア
                document.getElementById('dmm-product-details').innerHTML = 
                    '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
                document.getElementById('dlsite-product-details').innerHTML = 
                    '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
                document.getElementById('comparison-results').innerHTML = 
                    '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
                
                // モーダル表示
                var compareModal = new bootstrap.Modal(document.getElementById('compareModal'));
                compareModal.show();
                
                // API経由で商品比較データを取得
                fetch(`/api/compare_products?product1_id=${dmmId}&product2_id=${dlsiteId}`)
                    .then(response => response.json())
                    .then(data => {
                        // DMMの商品情報表示
                        const product1 = data.product1;
                        document.getElementById('dmm-product-details').innerHTML = 
                            renderProductDetails(product1, 'dmm');
                        
                        // DLsiteの商品情報表示
                        const product2 = data.product2;
                        document.getElementById('dlsite-product-details').innerHTML = 
                            renderProductDetails(product2, 'dlsite');
                        
                        // 比較結果表示
                        const comparison = data.comparison;
                        document.getElementById('comparison-results').innerHTML = 
                            renderComparisonResult(comparison, product1, product2);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('dmm-product-details').innerHTML = 
                            '<div class="alert alert-danger">データ取得中にエラーが発生しました</div>';
                        document.getElementById('dlsite-product-details').innerHTML = 
                            '<div class="alert alert-danger">データ取得中にエラーが発生しました</div>';
                        document.getElementById('comparison-results').innerHTML = 
                            '<div class="alert alert-danger">データ取得中にエラーが発生しました</div>';
                    });
            });
        });
        
        // 商品情報のレンダリング関数
        function renderProductDetails(product, platform) {
            if (!product) return '<div class="alert alert-warning">製品情報がありません</div>';
            
            const platformLabel = platform === 'dmm' ? 'DMM' : 'DLsite';
            
            let html = `
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">${product.title}</h5>
                        <div class="small text-muted mb-2">
                            ${platformLabel} ID: ${product.platform_id || '不明'}
                        </div>
                        <div class="mb-2">
                            <strong>価格:</strong> ¥${product.price || '不明'}
                        </div>
                        <div class="mb-2">
                            <strong>サークル/メーカー:</strong> ${product.maker || '不明'}
                        </div>
                        <div class="mb-2">
                            <strong>発売日:</strong> ${product.release_date || '不明'}
                        </div>`;
            
            if (product.category) {
                html += `<div class="mb-2">
                    <strong>カテゴリ:</strong> ${product.category}
                </div>`;
            }
            
            if (product.url) {
                html += `<div class="mt-3">
                    <a href="${product.url}" target="_blank" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-external-link-alt"></i> ${platformLabel}で表示
                    </a>
                </div>`;
            }
            
            html += `</div></div>`;
            
            // 価格履歴を取得するボタンを追加
            html += `<div class="text-center mb-3">
                <button class="btn btn-sm btn-info show-price-history" data-product-id="${product.id}">
                    <i class="fas fa-chart-line"></i> 価格履歴を表示
                </button>
                <div id="price-history-${product.id}" class="mt-2" style="display:none;"></div>
            </div>`;
            
            return html;
        }
        
        // 比較結果のレンダリング関数
        function renderComparisonResult(comparison, product1, product2) {
            if (!comparison) return '<div class="alert alert-warning">比較データがありません</div>';
            
            let html = '<div class="card">';
            html += '<div class="card-body">';
            
            // タイトル類似度
            const titleSimilarity = comparison.title_similarity * 100;
            const similarityColor = titleSimilarity > 90 ? 'success' : (titleSimilarity > 70 ? 'primary' : 'secondary');
            
            /* cssLint ignore:start */
            html += `<h6>タイトル類似度</h6>
            <div class="progress mb-3" style="height: 20px;">
                <div class="progress-bar bg-${similarityColor}" role="progressbar" 
                     style="width: ${titleSimilarity}%;" 
                     aria-valuenow="${titleSimilarity}" 
                     aria-valuemin="0" aria-valuemax="100">
                    ${titleSimilarity.toFixed(1)}%
                </div>
            </div>`;
            /* cssLint ignore:end */
            
            // 高度な類似度（もしあれば）
            if (comparison.advanced_similarity !== null) {
                const advSimilarity = comparison.advanced_similarity * 100;
                /* cssLint ignore:start */
                html += `<h6>高度な類似度分析（TF-IDF）</h6>
                <div class="progress mb-3" style="height: 20px;">
                    <div class="progress-bar bg-info" role="progressbar" 
                         style="width: ${advSimilarity}%;" 
                         aria-valuenow="${advSimilarity}" 
                         aria-valuemin="0" aria-valuemax="100">
                        ${advSimilarity.toFixed(1)}%
                    </div>
                </div>`;
                /* cssLint ignore:end */
            }
            
            // メーカー/サークル一致
            html += `<div class="mb-3">
                <h6>サークル/メーカー一致:</h6>
                <span class="badge bg-${comparison.maker_match ? 'success' : 'secondary'} p-2">
                    ${comparison.maker_match ? '一致しています' : '一致していません'}
                </span>
            </div>`;
            
            // 価格比較
            if (comparison.price_difference !== null) {
                const diffAbs = Math.abs(comparison.price_difference);
                const diffPercent = comparison.price_diff_percentage.toFixed(1);
                const cheaper = comparison.price_difference > 0 ? product2.platform.toUpperCase() : product1.platform.toUpperCase();
                const diffColor = comparison.price_difference !== 0 ? (cheaper === 'DLSITE' ? 'success' : 'warning') : 'secondary';
                
                html += `<div class="mb-3">
                    <h6>価格差:</h6>
                    <div class="alert alert-${diffColor} mb-0">
                        ${comparison.price_difference !== 0 
                            ? `${cheaper}の方が<strong>¥${diffAbs}</strong> (${diffPercent}%) 安いです` 
                            : '両方とも同じ価格です'}
                    </div>
                </div>`;
            } else {
                html += `<div class="mb-3">
                    <h6>価格差:</h6>
                    <div class="alert alert-warning mb-0">
                        片方または両方の価格が登録されていないため、比較できません
                    </div>
                </div>`;
            }
            
            // 総合評価
            html += `<div class="mt-4">
                <h6>総合評価:</h6>
                <div class="alert alert-${comparison.is_same_product ? 'success' : 'info'} mb-0">
                    ${comparison.is_same_product 
                        ? '<i class="fas fa-check-circle"></i> <strong>高確率で同一作品です</strong>' 
                        : '<i class="fas fa-question-circle"></i> <strong>類似していますが、同一作品とは言い切れません</strong>'}
                </div>
            </div>`;
            
            html += '</div></div>';
            
            return html;
        }
        
        // 価格履歴表示ボタンの処理
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('show-price-history') || 
                e.target.parentElement.classList.contains('show-price-history')) {
                    
                const button = e.target.classList.contains('show-price-history') 
                    ? e.target 
                    : e.target.parentElement;
                
                const productId = button.getAttribute('data-product-id');
                const historyContainer = document.getElementById(`price-history-${productId}`);
                
                if (historyContainer.style.display === 'none') {
                    historyContainer.style.display = 'block';
                    historyContainer.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> 読み込み中...</div>';
                    
                    // 価格履歴データを取得
                    fetch(`/api/price_history/${productId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.price_history && data.price_history.length > 0) {
                                let html = '<div class="card"><div class="card-body"><h6>価格履歴</h6><ul class="list-group">';
                                
                                data.price_history.forEach(item => {
                                    const date = item.date || '不明';
                                    const price = item.price || '不明';
                                    const source = item.source === 'current' ? '現在価格' : '購入時価格';
                                    
                                    html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>${date}</span>
                                        <span class="badge bg-primary rounded-pill">¥${price}</span>
                                        <span class="badge bg-secondary">${source}</span>
                                    </li>`;
                                });
                                
                                html += '</ul></div></div>';
                                historyContainer.innerHTML = html;
                            } else {
                                historyContainer.innerHTML = '<div class="alert alert-info">価格履歴データがありません</div>';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            historyContainer.innerHTML = '<div class="alert alert-danger">価格履歴の取得に失敗しました</div>';
                        });
                    
                    button.innerHTML = '<i class="fas fa-chart-line"></i> 価格履歴を隠す';
                } else {
                    historyContainer.style.display = 'none';
                    button.innerHTML = '<i class="fas fa-chart-line"></i> 価格履歴を表示';
                }
            }
        });
    });
</script>
{% endblock %}